pipeline {
    agent any
    environment {
        PATH = "/opt/maven/apache-maven-3.6.3/bin:$PATH"
    }
    stages {
        stage("clone code"){
            steps{
                git credentialsId: '0150992c-e728-4a81-865a-a336e007ae72', url: 'https://github.com/sailuj/simple-app.git'
            }
            
        }     
        stage("build code"){
            steps{
              sh "mvn clean install"
            }
         stage('Deploy'){
            steps{
            sh label: '', script: '''rm -rf dockerimg
    mkdir dockerimg
    cd dockerimg
    cp /var/lib/jenkins/workspace/testing_pipeline/target/simple-app-3.0.0-SNAPSHOT.war  .
    touch dockerfile
    cat <<EOT>>dockerfile          
    FROM tomcat
    ADD simple-app-3.0.0-SNAPSHOT.war /usr/local/tomcat/webapps/
    CMD ["catalina.sh", "run"]
    EXPOSE 8080
    EOT
    sudo docker build -t webimage:$BUILD_NUMBER .
    sudo docker container run -itd --name webserver$BUILD_NUMBER -p 8080 webimage:$BUILD_NUMBER'''    
        }
   }
   }
}      
